#!/bin/bash

set -e

echo -e "\n\033[1m     --------- \033[0m"
echo -e "\n\033[1m ||  OPENSETUP  || \033[0m\n"
echo -e "\033[1m     --------- \033[0m\n"

#Defaults
PORT="443"
PROTO="tcp"
SERVER_NAME="openserver"
PACKAGES="openvpn easy-rsa"
OPENSETUP_DIR="$HOME/.opensetup"

if [ -z "$1" ];
	then
		CLIENT_NAME="openclient"
		echo "CLIENT_NAME is set to default: openclient\n"
	else
		CLIENT_NAME=$1
fi

function create_home_dir() {
	if [ ! -d "$OPENSETUP_DIR" ]; then
		mkdir -p $OPENSETUP_DIR/keys
		chmod 700 $OPENSETUP_DIR
		cp /usr/share/easy-rsa/* $OPENSETUP_DIR
		echo "Created new opensetup directory: $OPENSETUP_DIR"
	fi
}

function set_key_variables() {
	export EASY_RSA="$OPENSETUP_DIR"
	export OPENSSL="openssl"
	export PKCS11TOOL="pkcs11-tool"
	export GREP="grep"
	export KEY_CONFIG=`$EASY_RSA/whichopensslcnf $EASY_RSA`
	export KEY_DIR="$EASY_RSA/keys"
	export PKCS11_MODULE_PATH="dummy"
	export PKCS11_PIN="dummy"
	export KEY_SIZE=2048
	export CA_EXPIRE=3650
	export KEY_EXPIRE=3650
	export KEY_COUNTRY="US"
	export KEY_PROVINCE="CA"
	export KEY_CITY="SanFrancisco"
	export KEY_ORG="Fort-Funston"
	export KEY_EMAIL="my@vpn.net"
	export KEY_OU="MyVPN"
	export KEY_NAME="$SERVER_NAME"
}

function clean_key_dir() {
	if [ "$KEY_DIR" ]; then
		rm -rf "$KEY_DIR"
		mkdir "$KEY_DIR" && chmod go-rwx "$KEY_DIR" && touch "$KEY_DIR/index.txt" && echo 01 >"$KEY_DIR/serial"
	fi
}

function build_certificate_authority() {
	export EASY_RSA="${EASY_RSA:-.}"
	"$EASY_RSA/pkitool" --batch --initca $*
}

function build_server_key() {
	export EASY_RSA="${EASY_RSA:-.}"
	"$EASY_RSA/pkitool" --batch --server $SERVER_NAME
}

function build_diffie_helman() {
	if [ -d $KEY_DIR ] && [ $KEY_SIZE ]; then
		$OPENSSL dhparam -out ${KEY_DIR}/dh${KEY_SIZE}.pem ${KEY_SIZE}
}

function generate_client_cert() {
	export EASY_RSA="${EASY_RSA:-.}"
	"$EASY_RSA/pkitool" --batch $CLIENT_NAME
}

function generate_server_conf_for_openvpn() {
	echo "port $PORT
	proto $PROTO
	dev tun
	ca ca.crt
	cert $SERVER_NAME.crt
	key $SERVER_NAME.key
	dh dh2048.pem
	server 10.8.0.0 255.255.255.0
	ifconfig-pool-persist ipp.txt
	push \042redirect-gateway def1 bypass-dhcp\042
	push \042dhcp-option DNS 8.8.8.8\042
	push \042dhcp-option DNS 8.8.4.4\042
	keepalive 10 120
	tls-auth ta.key 0
	key-direction 0
	cipher AES-128-CBC
	auth SHA256
	comp-lzo
	user nobody
	group nogroup
	persist-key
	persist-tun
	status openvpn-status.log

	# no logging
	verb 0
	" > /etc/openvpn/server.conf
}

function allow_ipv4_forwarding() {
	if sysctl net.ipv4.ip_forward | grep 0; then
		echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
		sysctl -p
	fi
}

function set_firewall() {
	echo -e "*nat
	:POSTROUTING ACCEPT [0:0]
	-A POSTROUTING -s 10.8.0.0/8 -o $(ip route | grep default | grep -Po '(?<=dev )(\S+)') -j MASQUERADE
	COMMIT
	" | cat - /etc/ufw/before.rules > /etc/ufw/before.rules
	cat /etc/default/ufw | sed 's/DEFAULT_FORWARD_POLICY="DROP"/DEFAULT_FORWARD_POLICY="ACCEPT"/' | tee /etc/default/ufw
	ufw allow OpenSSH
	ufw allow $PORT/$PROTO
	ufw disable
	ufw enable
}

function create_client_conf() {
	mkdir -p ~/$OPENSETUP_DIR/files
	chmod 700 ~/$OPENSETUP_DIR/files
	
}

IAM=$(whoami)
if [ ${IAM} != "root" ];
	echo -e "\033[0;31m\033[1m Only root is allowed to use this! \033[0m\n"
	exit 1
fi

apt-get update
apt-get install -y $PACKAGES

create_home_dir

set_key_variables
clean_key_dir

build_certificate_authority
build_server_key
openvpn --genkey --secret $OPENSETUP_DIR/keys/ta.key
generate_client_cert
cd $OPENSETUP_DIR/keys
cp ca.crt $SERVER_NAME.crt $SERVER_NAME.key ta.key dh2048.pem /etc/openvpn
generate_server_conf_for_openvpn
allow_ipv4_forwarding
set_firewall
systemctl start openvpn@$SERVER_NAME
systemctl enable openvpn@$SERVER_NAME
